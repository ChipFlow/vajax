name: Benchmark Comparison

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # Disabled sccache due to GitHub artifact cache outage (Dec 2025)
  # Re-enable when service is restored
  SCCACHE_GHA_ENABLED: "false"
  RUSTC_WRAPPER: "sccache"

jobs:
  benchmark-comparison:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            flex bison libfl-dev \
            libsuitesparse-dev \
            bc

      - name: Install LLVM 18
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          # Install additional LLVM tools needed by OpenVAF
          sudo apt-get install -y lld-18
          # Add LLVM tools to PATH and set environment
          echo "/usr/lib/llvm-18/bin" >> "$GITHUB_PATH"
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-18" >> "$GITHUB_ENV"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            openvaf-py
            openvaf-py/vendor/OpenVAF

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Build openvaf-py
        working-directory: openvaf-py
        run: |
          uv sync
          uv run maturin develop --release

      - name: Build openvaf-r (standalone compiler for VACASK)
        working-directory: openvaf-py/vendor/OpenVAF
        run: |
          # Build openvaf-r binary for OSDI compilation
          # Use --no-default-features --features llvm18 to build with LLVM 18 (default is LLVM 21)
          cargo build --release -p openvaf-driver --bin openvaf-r --no-default-features --features llvm18
          echo "OPENVAF_DIR=${{ github.workspace }}/openvaf-py/vendor/OpenVAF/target/release" >> "$GITHUB_ENV"

      - name: Install jax-spice
        run: uv sync --extra dev

      - name: Run JAX-SPICE tests
        env:
          JAX_PLATFORMS: cpu
        run: uv run pytest tests/test_vacask_suite.py tests/test_vacask_jax.py -v --tb=short

      # Build VACASK simulator
      - name: Cache Boost 1.88
        uses: actions/cache@v4
        id: cache-boost
        with:
          path: /tmp/boost_1_88_0
          key: boost-1.88.0-${{ runner.os }}

      - name: Download and build Boost 1.88
        if: steps.cache-boost.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          wget -q https://archives.boost.io/release/1.88.0/source/boost_1_88_0.tar.gz
          tar -xzf boost_1_88_0.tar.gz
          cd boost_1_88_0
          ./bootstrap.sh --with-libraries=filesystem,process,system
          ./b2 -j"$(nproc)" link=static

      - name: Download toml++ 3.4.0
        run: |
          cd /tmp
          wget -q https://github.com/marzer/tomlplusplus/archive/refs/tags/v3.4.0.tar.gz
          tar -xzf v3.4.0.tar.gz

      - name: Cache VACASK build
        uses: actions/cache@v4
        with:
          path: vendor/VACASK/build
          key: vacask-build-${{ runner.os }}-${{ hashFiles('vendor/VACASK/CMakeLists.txt', 'vendor/VACASK/lib/**', 'vendor/VACASK/simulator/**') }}

      - name: Build VACASK
        run: |
          cd vendor/VACASK
          mkdir -p build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBoost_NO_SYSTEM_PATHS=TRUE \
            -DBoost_INCLUDE_DIR=/tmp/boost_1_88_0 \
            -DCMAKE_PREFIX_PATH="/tmp/boost_1_88_0/stage/lib/cmake" \
            -DTOMLPP_DIR=/tmp/tomlplusplus-3.4.0 \
            -DOPENVAF_DIR="${OPENVAF_DIR}"
          # Build simulator and OSDI device files
          ninja vacask
          # Try to build device OSDI files (may fail on some platforms)
          ninja build_and_stage_devices || {
            echo "Warning: OSDI device compilation failed"
            echo "=== OpenVAF crash logs ==="
            cat /tmp/openvaf-crash-*.log 2>/dev/null || echo "No crash logs found"
          }

      # Run automated VACASK result comparison tests
      # These tests compare simulation waveforms between JAX-SPICE and VACASK
      # Tests marked with xfail are expected to fail and won't break CI
      - name: Run VACASK result comparison tests
        env:
          JAX_PLATFORMS: cpu
          JAX_ENABLE_X64: "1"
          VACASK_BIN: ${{ github.workspace }}/vendor/VACASK/build/simulator/vacask
        run: |
          echo "Running automated VACASK result comparison tests..."
          # Run pytest with the VACASK comparison tests
          # Tests use xfail for known-failing benchmarks so this won't break CI
          uv run pytest tests/test_vacask_benchmarks.py -v \
            -k "TestVACASKResultComparison" \
            --tb=short 2>&1 | tee /tmp/vacask-result-tests.log || true

      # Run benchmark performance comparison
      # NOTE: VACASK benchmarks require OSDI device files compiled by openvaf-r
      # This currently crashes on Linux/LLVM18, so VACASK results may not be available
      - name: Run benchmark performance comparison
        env:
          JAX_PLATFORMS: cpu
          JAX_ENABLE_X64: "1"
        run: |
          echo "Running JAX-SPICE vs VACASK comparison..."
          # Run comparison script - it handles VACASK availability gracefully
          # Note: c6288 is excluded because JIT compilation takes >10min on CPU
          # For c6288, use GPU via: scripts/profile_gpu_cloudrun.py --benchmark c6288
          uv run python scripts/compare_vacask.py \
            --benchmark rc,graetz,ring \
            --max-steps 200 \
            --use-scan 2>&1 | tee /tmp/benchmark-comparison.log || true

      # Generate comparison summary for GitHub step output
      - name: Generate comparison summary
        run: |
          {
            echo "## Benchmark Comparison: JAX-SPICE vs VACASK"
            echo ""
            echo "### Environment"
            echo "- **Platform**: CPU (GitHub Actions runner)"
            echo "- **JAX Backend**: cpu"
            echo "- **Mode**: lax.scan (JIT-compiled)"
            echo "- **Steps**: 200"
            echo ""

            # Report VACASK result comparison tests
            echo "### Result Accuracy Tests"
            echo ""
            if [ -f "/tmp/vacask-result-tests.log" ]; then
              echo "| Benchmark | Status | Details |"
              echo "|-----------|--------|---------|"

              # Extract test results for each benchmark
              for bench in rc graetz ring mul; do
                if grep -q "test_transient_matches_vacask\[${bench}\].*PASSED" /tmp/vacask-result-tests.log; then
                  echo "| ${bench} | ✅ PASSED | Waveform matches VACASK |"
                elif grep -q "test_transient_matches_vacask\[${bench}\].*XFAIL" /tmp/vacask-result-tests.log; then
                  reason=$(grep "test_transient_matches_vacask\[${bench}\]" /tmp/vacask-result-tests.log | head -1 | sed 's/.*reason=//' || echo "Expected failure")
                  echo "| ${bench} | ⚠️ XFAIL | ${reason} |"
                elif grep -q "test_transient_matches_vacask\[${bench}\].*SKIPPED" /tmp/vacask-result-tests.log; then
                  echo "| ${bench} | ⏭️ SKIPPED | VACASK binary not available |"
                elif grep -q "test_transient_matches_vacask\[${bench}\].*FAILED" /tmp/vacask-result-tests.log; then
                  echo "| ${bench} | ❌ FAILED | Unexpected failure |"
                fi
              done

              echo ""
              echo "_Tests marked XFAIL are known limitations being worked on._"
              echo ""
            else
              echo "**Warning**: Result comparison tests log not found"
              echo ""
            fi

            # Extract and display the comparison output
            if [ -f "/tmp/benchmark-comparison.log" ]; then
              # Check if VACASK was available and working
              if grep -q "VACASK binary: NOT FOUND" /tmp/benchmark-comparison.log; then
                echo "### ⚠️ VACASK Binary Not Found"
                echo ""
                echo "VACASK simulator binary was not built. Check the Build VACASK step."
                echo ""
              elif grep -q "\.osdi' not found" /tmp/benchmark-comparison.log; then
                echo "### ⚠️ VACASK OSDI Files Missing"
                echo ""
                echo "VACASK binary exists but OSDI device files are missing."
                echo "openvaf-r OSDI compilation fails on Linux/LLVM18 (known upstream issue)."
                echo "JAX-SPICE benchmarks ran successfully - showing JAX-SPICE only results."
                echo ""
                echo "For full comparison results, run locally on macOS."
                echo ""
              fi

              echo "### Per-Step Timing"
              echo ""
              echo "| Benchmark | Steps | JAX-SPICE (ms/step) | VACASK (ms/step) | Ratio |"
              echo "|-----------|-------|---------------------|------------------|-------|"

              # Parse the per-step summary table from the log
              grep -A 10 "Summary (per-step timing)" /tmp/benchmark-comparison.log | \
                grep "^|" | tail -n +3 | while read -r line; do
                echo "$line"
              done

              echo ""
              echo "### Total Wall Time"
              echo ""
              echo "| Benchmark | Steps | JAX-SPICE (ms) | VACASK (ms) | Ratio |"
              echo "|-----------|-------|----------------|-------------|-------|"

              # Parse the total time summary table from the log
              grep -A 10 "Summary (total wall time)" /tmp/benchmark-comparison.log | \
                grep "^|" | tail -n +3 | while read -r line; do
                echo "$line"
              done

              echo ""
              echo "### Interpretation"
              echo ""
              echo "- **Ratio < 1.0**: JAX-SPICE is faster"
              echo "- **Ratio > 1.0**: JAX-SPICE is slower (overhead-dominated for small circuits)"
              echo "- **N/A**: VACASK comparison not available"
              echo ""
              echo "_Note: JAX-SPICE scales better than VACASK for large circuits (e.g., c6288 is 41% faster on local macOS tests)._"
            else
              echo "**Error**: Benchmark comparison log not found"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload benchmark logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-logs
          path: |
            /tmp/benchmark-comparison.log
            /tmp/vacask-result-tests.log
