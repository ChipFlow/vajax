name: nsys-jax GPU Profiling (Cloud Run)

on:
  workflow_dispatch:
    inputs:
      circuit:
        description: 'Circuit to profile'
        type: choice
        options:
          - rc
          - graetz
          - mul
          - ring
        default: ring
      timesteps:
        description: 'Number of timesteps'
        default: '50'
      skip_warmup:
        description: 'Skip warmup (include JIT in profile)'
        type: boolean
        default: false

env:
  GCP_PROJECT: jax-spice-cuda-test
  GCP_REGION: us-central1
  JOB_NAME: jax-spice-nsys-profile
  AR_REMOTE_REPO: ghcr-remote

jobs:
  nsys-profile:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'beta'

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image names (lowercase for ghcr.io)
        run: |
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          GHCR_IMAGE="ghcr.io/${REPO_LC}/gpu-base"
          echo "GHCR_IMAGE=${GHCR_IMAGE}" >> "$GITHUB_ENV"
          echo "GHCR_PATH=${REPO_LC}/gpu-base" >> "$GITHUB_ENV"

      - name: Free disk space for Docker build
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          # Remove large unused directories
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Check if base image needs rebuild
        id: check-rebuild
        run: |
          # Check if base image exists with current deps hash
          DEPS_HASH=$(cat pyproject.toml uv.lock scripts/run-gpu-tests.sh Dockerfile.gpu-base | sha256sum | cut -c1-12)
          echo "deps_hash=${DEPS_HASH}" >> "$GITHUB_OUTPUT"

          # Check if image exists using manifest inspect (fast - only fetches metadata)
          if docker manifest inspect "${{ env.GHCR_IMAGE }}:${DEPS_HASH}" > /dev/null 2>&1; then
            echo "Base image exists for deps hash ${DEPS_HASH}"
            echo "needs_rebuild=false" >> "$GITHUB_OUTPUT"
          else
            echo "Base image needs rebuild (deps hash: ${DEPS_HASH})"
            echo "needs_rebuild=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.check-rebuild.outputs.needs_rebuild == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build and push base image (if needed)
        if: steps.check-rebuild.outputs.needs_rebuild == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.gpu-base
          push: true
          tags: |
            ${{ env.GHCR_IMAGE }}:${{ steps.check-rebuild.outputs.deps_hash }}
            ${{ env.GHCR_IMAGE }}:latest
          provenance: false
          cache-from: |
            type=registry,ref=${{ env.GHCR_IMAGE }}:latest
            type=gha
          cache-to: |
            type=gha

      - name: Set image tag for Cloud Run
        run: |
          AR_IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.AR_REMOTE_REPO }}/${{ env.GHCR_PATH }}:${{ steps.check-rebuild.outputs.deps_hash }}"
          echo "IMAGE_TAG=${AR_IMAGE}" >> "$GITHUB_ENV"
          echo "Cloud Run will use: ${AR_IMAGE}"

      - name: Generate profile script
        id: script
        run: |
          TIMESTAMP=$(date +%s)
          PROFILE_NAME="nsys-${{ inputs.circuit }}-${TIMESTAMP}"
          GCS_BUCKET="gs://${{ env.GCP_PROJECT }}-traces"

          echo "profile_name=${PROFILE_NAME}" >> "$GITHUB_OUTPUT"
          echo "gcs_path=${GCS_BUCKET}/${PROFILE_NAME}.zip" >> "$GITHUB_OUTPUT"

          SKIP_WARMUP_FLAG=""
          if [ "${{ inputs.skip_warmup }}" = "true" ]; then
            SKIP_WARMUP_FLAG="--skip-warmup"
          fi

          # Create the profiling script
          cat > /tmp/profile_script.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e

          cd /app

          # Clone repo at current SHA
          git clone --depth 1 --recurse-submodules https://github.com/${{ github.repository }}.git source
          cd source
          git fetch origin ${{ github.sha }} --depth=1
          git checkout ${{ github.sha }}

          # Install deps
          uv sync --locked --extra cuda12

          echo "=== Starting nsys-jax GPU Profiling ==="
          echo "Circuit: ${{ inputs.circuit }}"
          echo "Timesteps: ${{ inputs.timesteps }}"
          echo "Commit: ${{ github.sha }}"

          # Run profiling with nsys-jax
          nsys-jax -o /tmp/PROFILE_NAME_PLACEHOLDER.zip \
              uv run python scripts/nsys_profile_target.py ${{ inputs.circuit }} ${{ inputs.timesteps }} SKIP_WARMUP_PLACEHOLDER

          # Upload profile archive to GCS using curl (no gsutil needed)
          echo "=== Uploading profile to GCS ==="
          TOKEN=$(curl -sf "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" \
              -H "Metadata-Flavor: Google" | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          curl -sf -X POST \
              "https://storage.googleapis.com/upload/storage/v1/b/${{ env.GCP_PROJECT }}-traces/o?uploadType=media&name=PROFILE_NAME_PLACEHOLDER.zip" \
              -H "Authorization: Bearer \$TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @/tmp/PROFILE_NAME_PLACEHOLDER.zip
          echo "Upload complete"

          echo "=== Profiling Complete ==="
          SCRIPT_EOF

          # Replace placeholders
          sed -i "s/PROFILE_NAME_PLACEHOLDER/${PROFILE_NAME}/g" /tmp/profile_script.sh
          sed -i "s/SKIP_WARMUP_PLACEHOLDER/${SKIP_WARMUP_FLAG}/g" /tmp/profile_script.sh

          # Base64 encode for safe passing to Cloud Run
          SCRIPT_B64=$(base64 -w0 /tmp/profile_script.sh)
          echo "script_b64=${SCRIPT_B64}" >> "$GITHUB_OUTPUT"

      - name: Create or update Cloud Run Job
        run: |
          # Check if job exists
          if gcloud run jobs describe "${{ env.JOB_NAME }}" --region="${{ env.GCP_REGION }}" 2>/dev/null; then
            echo "Updating existing job..."
            gcloud run jobs update "${{ env.JOB_NAME }}" \
              --region="${{ env.GCP_REGION }}" \
              --image="${{ env.IMAGE_TAG }}" \
              --execution-environment=gen2 \
              --gpu=1 \
              --gpu-type=nvidia-l4 \
              --no-gpu-zonal-redundancy \
              --cpu=4 \
              --memory=16Gi \
              --max-retries=0 \
              --task-timeout=30m \
              --command=bash \
              --args="-c,echo ${{ steps.script.outputs.script_b64 }} | base64 -d | bash"
          else
            echo "Creating new job..."
            gcloud run jobs create "${{ env.JOB_NAME }}" \
              --region="${{ env.GCP_REGION }}" \
              --image="${{ env.IMAGE_TAG }}" \
              --execution-environment=gen2 \
              --gpu=1 \
              --gpu-type=nvidia-l4 \
              --no-gpu-zonal-redundancy \
              --cpu=4 \
              --memory=16Gi \
              --max-retries=0 \
              --task-timeout=30m \
              --command=bash \
              --args="-c,echo ${{ steps.script.outputs.script_b64 }} | base64 -d | bash"
          fi

      - name: Execute Cloud Run Job
        run: |
          echo "Starting nsys-jax profiling for ${{ inputs.circuit }} (${{ inputs.timesteps }} timesteps)..."

          # Execute and capture execution name
          exec_id=$(gcloud run jobs execute "${{ env.JOB_NAME }}" \
            --region="${{ env.GCP_REGION }}" \
            --async \
            --format="value(metadata.name)")

          echo "Execution started: $exec_id"
          echo "exec_id=$exec_id" >> "$GITHUB_ENV"
          echo
          echo "Waiting for run:"

          # Get execution status
          status="Unknown"
          until [[ "$status" != "Unknown" ]]; do
            status=$(gcloud run jobs executions describe "$exec_id" \
              --region="${{ env.GCP_REGION }}" \
              --format="value(status.conditions[0].status)")
            stdbuf -oL echo -n .
            sleep 5
          done

          echo

          # Capture logs to file for parsing
          gcloud beta run jobs executions logs read "$exec_id" \
            --region="${{ env.GCP_REGION }}" | tee /tmp/job_logs.txt

          status=$(gcloud run jobs executions describe "$exec_id" \
            --region="${{ env.GCP_REGION }}" \
            --format="value(status.conditions[0].status)")
          echo
          echo "Status: $status"

          if [ "$status" != "True" ]; then
            exit 1
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "## nsys-jax GPU Profiling Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Circuit:** ${{ inputs.circuit }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Timesteps:** ${{ inputs.timesteps }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Commit:** ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f /tmp/job_logs.txt ]; then
            echo "### Profile Location" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Profile archive uploaded to:" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
            echo "${{ steps.script.outputs.gcs_path }}" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Download Instructions" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`bash" >> "$GITHUB_STEP_SUMMARY"
            echo "# Download the profile archive" >> "$GITHUB_STEP_SUMMARY"
            echo "gsutil cp ${{ steps.script.outputs.gcs_path }} /tmp/${{ steps.script.outputs.profile_name }}.zip" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "# Extract and analyze" >> "$GITHUB_STEP_SUMMARY"
            echo "unzip /tmp/${{ steps.script.outputs.profile_name }}.zip -d /tmp/nsys-profile" >> "$GITHUB_STEP_SUMMARY"
            echo "cd /tmp/nsys-profile && bash install.sh" >> "$GITHUB_STEP_SUMMARY"
            echo "jupyter lab Analysis.ipynb" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "# Or view in Nsight Systems GUI" >> "$GITHUB_STEP_SUMMARY"
            echo "nsys-ui /tmp/nsys-profile/*.nsys-rep" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          fi
