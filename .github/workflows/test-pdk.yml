name: PDK Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test-pdk:
    runs-on: ubuntu-latest
    # Only run on internal PRs (not forks) where secrets are available
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup SSH for private repos
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PDK_DEPLOY_KEY }}

      - name: Clone GF130 PDK (sparse checkout)
        run: |
          # Use sparse checkout to only fetch Verilog-A model directories
          git clone --quiet --filter=blob:none --sparse git@github.com:ChipFlow/pdk-gf130.git /tmp/pdk-gf130
          cd /tmp/pdk-gf130
          git sparse-checkout set --no-cone '*/Models/HSPICE' '*/Models/Spectre'
          echo "PDK_GF130_PATH=/tmp/pdk-gf130" >> $GITHUB_ENV
          # Mask PDK path in all subsequent log output
          echo "::add-mask::/tmp/pdk-gf130"

      - name: Install LLVM 18
        run: |
          wget -q https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-18" >> $GITHUB_ENV

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            OpenVAF
            openvaf-py

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.10

      - name: Build and install openvaf-py
        working-directory: openvaf-py
        run: |
          uv sync
          uv run maturin develop --release

      - name: Run PDK tests
        working-directory: openvaf-py
        # Use --tb=line for minimal tracebacks to avoid leaking paths
        run: uv run pytest tests_pdk/ -v --tb=line
